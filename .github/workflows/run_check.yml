name: Check IPTV and Update List

on:
  schedule:
    # 每天北京时间早上 6:00 自动运行 (UTC 22:00)
    - cron: '0 22 * * *'
  workflow_dispatch: # 允许你手动点击按钮随时运行

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp numpy

      - name: 运行脚本
        run: python m3ucheck.py

      - name: 提交并同步到仓库
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # 检查是否有新生成的 itvlist.m3u
          if [ -f "itvlist.m3u" ]; then
            git add itvlist.m3u
            # 只有当文件内容真的发生变化时才提交，避免产生无意义的日志
            git commit -m "自动更新节目列表: $(date +'%Y-%m-%d %H:%M')" || echo "内容无变化，跳过提交"
            git push
          else
            echo "未找到生成的 itvlist.m3u 文件，请检查脚本输出"
            exit 1
          fi
